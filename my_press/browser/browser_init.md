---
title: 宏观视角下的浏览器
category: 浏览器
tag:
  - 浏览器
  - chrome
comment: false
---

# chrome架构：仅仅打开一个页面，为什么有4个进程？
## 线程和进程的关系
线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率。
1. 进程中的任意一线程执行出错，都会导致整个进程的崩溃。
2. 线程之间共享进程中的数据。
3. 当一个进程关闭之后，操作系统会回收进程所占用的内存。
4. 进程之间的内容相互隔离。

> IPC是进程之间的通信机制

## 单进程浏览器缺点
定义：所有功能模块都运行在一个进程里

### 不稳定：模块中任意内容出现崩溃都会导致整个浏览器崩溃

### 不流畅
1. 页面的渲染模块、javascript执行环境、以及插件都是运行在同一个线程（单进程中的主线程）中，意味着同一时刻只有一个模块可以执行
2. 页面内存泄漏也会导致单进程卡顿 

### 不安全
1. 插件使用c/c++编写，通过插件可以获取操作系统的任意资源

## 早期多进程架构浏览器

### 解决不稳定问题
由于进程是相互隔离的，所以当一个页面或者插件崩溃时，影响到的仅仅是当前的页面进程或者插件进程

### 解决不流畅问题
1. JavaScript 也是运行在渲染进程中的，所以即使 JavaScript 阻塞了渲染进程，影响到的也只是当前的渲染页面，而并不会影响浏览器和其他页面，因为其他页面的脚本是运行在它们自己的渲染进程中的。
2. 对于内存泄漏的解决方法那就更简单了，因为当关闭一个页面时，整个渲染进程也会被关闭，之后该进程所占用的内存都会被系统回收，这样就轻松解决了浏览器页面的内存泄漏问题。

### 解决不安全问题
1. 使用安全沙箱隔离

## 目前多进程架构
![image](https://static001.geekbang.org/resource/image/b6/fc/b61cab529fa31301bde290813b4587fc.png)
最新的 Chrome 浏览器包括：1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程。

- **浏览器进程**：主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。
- **渲染进程**：核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。
- **GPU进程**：其实，Chrome 刚开始发布的时候是没有 GPU 进程的。而 GPU 的使用初衷是为了实现 3D CSS 的效果，只是随后网页、Chrome 的 UI 界面都选择采用 GPU 来绘制，这使得 GPU 成为浏览器普遍的需求。最后，Chrome 在其多进程架构上也引入了 GPU 进程。
- **网络进程**：负责资源的加载，在单进程中是作为一个模块使用的。
- **插件进程**：主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

### 存在问题
1. 更高的资源利用
2. **更复杂的体系架构**，浏览器各模块之间耦合性高、扩展性差等问题，会导致现在的架构已经很难适应新的需求了。

## 未来（过渡阶段）面向服务的架构
1. chrome官方团队2016年提出的面向服务的架构，必须使用接口去使用服务，多个服务间采用IPC通信

## 多进程架构仍然存在一个标签页崩溃整个浏览器崩溃的原因
通常情况下是一个页面使用一个进程，但是，有一种情况，叫"同一站点(same-site)"。

Chrome针对同一站点的默认策略是，每个标签对应一个渲染进程。但是如果从一个页面打开了新页面，而新页面和当前页面属于同一站点时，那么新页面会复用父页面的渲染进程。官方把这个默认策略叫process-per-site-instance。直白的讲，就是如果几个页面符合同一站点，那么他们将被分配到一个渲染进程里面去。
所以，这种情况下，一个页面崩溃了，会导致同一站点的页面同时崩溃，因为他们使用了同一个渲染进程。


# TCP协议：如何保证页面文件能被完整送达浏览器？

## FP(First Paint)
衡量web性能的重要指标：FP（First Paint），指从页面加载到首次绘制的时长；

影响FP的指标的重要因素是网络加载速度

## 如何优化网络加载速度？
HTTP、websocket都是基于TCP/IP协议族的

文件传送流程是将文件转换成数据包进行传送的，若当前数据包过大则将它拆分成多个小的数据包进行传送

### IP（Internet Protocol） 网际协议
功能：负责将数据包传到目标主机，==但是目标主机不知道把数据包交给哪个程序==
IP数据包中IP头包含IP版本、源IP地址、目标IP地址、生存时间等信息

### UDP（User Data Protocol）用户数据协议
功能：通过端口解决目标主机无法确定数据包交给哪个程序的问题，==但是有各种因素会导致数据包出错，虽然 UDP 可以校验数据是否正确，但是对于错误的数据包，UDP 并不提供重发机制，只是丢弃当前的包，而且 UDP 在发送之后也无法知道是否能达到目的地。==

流程：端口号被装进UDP头里（包括目标端口和源都那口），UDP和原始数据组成新的数据包

### TCP（Transmission Control Protocol）传输控制协议
TCP是一种面向连接的、可靠的、基于字节流的传输层通信协议
功能：  
- 对于数据包丢失的情况，TCP 提供重传机制；
- TCP 引入了数据包排序机制，用来保证把乱序的数据包组合成一个完整的文件

相较于UDP，TCP头部多了可以用来排序的序列号，以便接收端通过序列号来重排数据包

#### 完整TCP连接过程
- 三次握手建立连接
- 传输阶段，接收端对已成功的包发回一个确认包（ACK）,如果发送端实体在合理的往返时延（RTT）内未收到确认，那么对应的数据包就被假设为已丢失将会被进行重传
- 四次挥手断开连接