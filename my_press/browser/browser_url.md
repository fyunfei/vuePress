---
title: 从输入URL到页面展示，这中间发生了什么？
category: 浏览器
tag:
  - 浏览器
  - chrome
comment: false
---

# 主要流程
![](https://static001.geekbang.org/resource/image/92/5d/92d73c75308e50d5c06ad44612bcb45d.png)

从图中可知，在这个阶段三个进程间（浏览器进程，网络进程，渲染进程）需要相互配合。

从输入URL到页面展示大概分为三个阶段：
1. 用户输入
2. URL请求
3. 准备渲染进程
4. 提交文档
5. 渲染阶段

## 用户输入阶段
当用户在地址栏输入内容搜索时，浏览器首先会判断当前输入内容是否符合URL规则，符合规则对URL进行处理进行URL请求流程，若不符合则按照正常的搜索流程，根据浏览器设置的默认搜索引擎进行关键字搜索。

注：当我们已经进入某一页面时，在当前页面进行页面跳转之前，会触发一个beforeunload事件，我们可以通过beforeunload事件来取消导航。

## URL请求阶段
浏览器进程会通过进程间通信（IPC）把 URL 请求发送至网络进程，网络进程接收到 URL 请求后，会在这里发起真正的 URL 请求流程。

首先网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程；如果在缓存中没有查找到资源，那么直接进入网络请求流程。这请求前的第一步是要进行 DNS 解析，以获取请求域名的服务器 IP 地址。如果请求协议是 HTTPS，那么还需要建立 TLS 连接。

接下来就是利用 IP 地址和服务器建立TCP连接。连接建立之后，浏览器端会构建请求行、请求头等信息，并把和该域名相关的Cookie等数据附加到请求头中，然后向服务器发送构建的请求信息。

服务器接收到请求信息后，会根据请求信息生成响应数据（包括响应行、响应头和响应体等信息），并发给网络进程。等网络进程接收了响应行和响应头之后，就开始解析响应头的内容了。

1. 当响应结果遇到了重定向状态码，则将当前页面重定向到location中，重新进行该流程；若状态码是200则表示成功响应，并进行下一步
2. 对响应类型进行判断，若当前类型为文档类型则准备进行下一步准备渲染进程阶段；若为字节流模式则进行下载。

## 准备渲染进程
默认情况下，Chrome 会为每个页面分配一个渲染进程，但是，当我们从当前页面跳转到另一个页面时，若跳转页面与当前页面存在公共的根域名，这些页面会公用一个渲染进程。
注：新建tab标签页输入url跳转的方式会重新开一个渲染进程

## 提交文档阶段
所谓提交文档，就是指浏览器进程将网络进程接收到的HTML数据提交给渲染进程，具体流程是这样的：
- 首先当浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起“提交文档”的消息；
- 渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”；
- 等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程；
- 浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面。

## 渲染阶段
渲染过程主要分为：
1. 构建dom树
2. 样式计算
3. 布局
4. 光栅化
5. 合成

### 构建DOM树
因为浏览器无法理解和使用html，所以需要将html转换成DOM树结构

### 样式计算
#### 1. 把css转换为浏览器能够理解的结构
当渲染引擎接收到 CSS 文本时，会执行一个转换操作，将CSS文本转换为浏览器可以理解的结构——styleSheets，早期浏览器策略是将css转换成cssom
#### 2. 转换样式表中的属性值
将样式标准化，例如将em转换为相应的px值
#### 3. 计算每个节点的具体样式
将样式与树节点一一对用并将结果保存到ComputedStyle结构中

### 布局
布局主要是创建布局树，布局树中包括所有可见元素。
1. 创建布局树
2. 布局计算，主要负责计算每个节点的位置并保存在布局树中

### 分层
页面中通常会存在一部分复杂效果，如一些复杂的 3D 变换、页面滚动，或者使用 z-indexing 做 z 轴排序等，渲染引擎会针对这些效果生成图层，并生成一颗图层树。

#### 图层和节点之间的关系
1. 针对被裁剪的节点生成图层
2. 针对层叠上下文会生成图层
> 层叠上下文可理解为元素渲染顺序在三维环境受z轴影响

#### 图层绘制


### 绘制列表

### 光栅化（图块转换为位图）
1. 将绘制好的图层划分为图块（在**合成线程**中执行）
2. 生成位图（栅格化线程池-栅格化线程-GPU进程）
    - 只会将视口和视口周围部分生成位图

### 合成及显示
1. 光栅化流程接数后会发起DrawQuad指令给浏览器进程
2. 浏览器进程里面有一个叫 viz 的组件，用来接收合成线程发过来的 DrawQuad 命令，然后根据 DrawQuad 命令，将其页面内容绘制到内存中，最后再将内存显示在屏幕上。

### 重排、重绘
- 重排会重新触发样式计算后的全部流程，效率较低
- 重绘会触发样式计算，但是跳过了布局和分层阶段，效率相对重排来说好一些
